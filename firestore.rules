rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // NOTE: Since we're using Supabase Auth (not Firebase Auth),
    // request.auth will be null. We're allowing access based on
    // document structure and trusting the client-side validation.
    // For production, consider using Firebase Admin SDK with custom tokens
    // or migrating data to Supabase.

    // Helper function to check if a user is staff (not usable without Firebase Auth)
    function isStaff(userId) {
      return exists(/databases/$(database)/documents/staff/$(userId));
    }

    // Notes collection
    match /notes/{noteId} {
      allow read, write: if true;
    }

    // Messages (chat)
    match /messages/{chatId} {
      allow read, write: if true;
    }

    // Staff users - profile data and stats
    match /staff/{staffId} {
      allow read, write: if true;
    }

    // Student users - profile data
    match /students/{studentId} {
      allow read, write: if true;

      // Student's individual task completion status
      match /task_status/{taskId} {
        allow read, write: if true;
      }

      // Marks for assignments
      match /marks/{assignmentId} {
        allow read, write: if true;
      }

      // Submissions for assignments
      match /submissions/{submissionId} {
        allow read, write: if true;
      }

      // Goals
      match /goals/{goalDocId} {
        allow read, write: if true;
      }

      // Notifications
      match /notifications/{notificationId} {
        allow read, write: if true;
      }

      // Feedback
      match /feedback/{feedbackId} {
        allow read, write: if true;
      }

      // Analytics subcollection for student progress tracking
      match /analytics/{document} {
        allow read, write: if true;
      }
    }

    // Allow users to read the students collection
    match /students {
      allow read, write: if true;
    }

    // Tasks (shared document structure)
    match /tasks/shared {
      allow read, write: if true;
    }

    // Leaderboard
    match /leaderboard/{documentId} {
      allow read, write: if true;
    }

    // Circulars
    match /circulars/{circularId} {
      allow read, write: if true;
    }

    // Assignments
    match /assignments/{assignmentId} {
      allow read, write: if true;
    }

    // Student activities (for monitoring)
    match /student_activities/{activityId} {
      allow read, write: if true;
    }

    // App settings (like YouTube)
    match /settings/{document} {
      allow read, write: if true;
    }
  }
}